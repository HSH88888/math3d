<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lego Math World: Ultimate Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Jua&display=swap" rel="stylesheet">
    <style>
        /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Jua', sans-serif; user-select: none; touch-action: none; }
        .hidden { display: none !important; }
        
        /* === UI ë²„íŠ¼ === */
        .ui-btn {
            background: #fff; border: 4px solid #333; border-radius: 15px;
            padding: 10px 20px; font-size: 20px; font-family: 'Jua', sans-serif;
            cursor: pointer; box-shadow: 0 5px 0 #333; transition: transform 0.1s;
            margin: 5px; color: #333; pointer-events: auto;
        }
        .ui-btn:active { transform: translateY(5px); box-shadow: 0 0 0 #333; }
        .btn-primary { background: #FFC107; } 
        .btn-success { background: #8BC34A; color: white; }
        .btn-danger { background: #FF5252; color: white; }

        /* === ë©”ì¸ ë©”ë‰´ === */
        #main-menu, #char-select {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 500;
        }
        #title-logo { font-family: 'Black Han Sans', sans-serif; font-size: 70px; color: #FFF; text-shadow: 4px 4px 0 #000; margin-bottom: 30px; text-align: center; }

        /* === ìºë¦­í„° ì¹´ë“œ === */
        .char-card {
            width: 120px; height: 150px; background: rgba(255,255,255,0.2); border: 4px solid white;
            border-radius: 15px; margin: 10px; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .char-card:hover { background: rgba(255,255,255,0.5); transform: scale(1.1); }
        .char-icon { font-size: 50px; }

        /* === ì¸ê²Œì„ HUD === */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        #hud-top-bar {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            display: flex; justify-content: space-between; align-items: flex-start;
            box-sizing: border-box; pointer-events: none;
        }
        #score-box { text-shadow: 2px 2px 0 #000; color: white; font-size: 24px; }
        
        /* ë„ê° UI */
        #collection-container {
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 5px 15px;
            display: flex; flex-direction: column; align-items: center; pointer-events: auto;
        }
        #collection-title { color: #FFC107; font-size: 16px; margin-bottom: 5px; text-shadow: 1px 1px 0 #000; }
        #collection-slots { display: flex; gap: 5px; height: 40px; overflow-x: auto; max-width: 300px; }
        .collected-item { 
            width: 35px; height: 35px; background: rgba(255,255,255,0.8); border-radius: 50%; border: 2px solid #fff;
            display: flex; justify-content: center; align-items: center; font-size: 20px; flex-shrink: 0;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; 
            background: rgba(255,255,255,0.5); border: 2px solid black; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none;
        }
        
        #minimap-container {
            position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px;
            background: rgba(0,0,0,0.4); border: 4px solid #fff; border-radius: 50%; 
            overflow: hidden; z-index: 90; pointer-events: none;
        }

        /* === í€´ì¦ˆì°½ (ê°œì„ ëœ UI) === */
        #quiz-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1500; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        #quiz-box {
            background: #fff; 
            border: 8px solid #FF9800; border-radius: 30px;
            width: 85%; max-width: 400px; 
            padding: 40px 20px 30px 20px; text-align: center; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        #quiz-type-badge {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: #2196F3; color: white; 
            padding: 8px 30px; border-radius: 50px;
            border: 4px solid #fff; font-weight: bold; font-size: 20px;
            box-shadow: 0 5px 0 #1565C0;
        }
        #quiz-level { 
            font-size: 16px; color: #fff; background: #AAA; 
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            margin-top: 10px; font-weight: bold;
        }
        #quiz-question { 
            font-size: 45px; font-family: 'Black Han Sans', sans-serif;
            margin: 20px 0 30px 0; color: #333; text-shadow: 2px 2px 0 #ddd;
        }
        #answer-input { 
            font-size: 32px; padding: 15px; width: 80%; 
            text-align: center; border-radius: 15px; 
            border: 4px solid #ddd; background: #f5f5f5; 
            font-family: 'Jua', sans-serif; outline: none; transition: 0.3s; margin-bottom: 25px;
        }
        #answer-input:focus { border-color: #2196F3; background: #fff; }
        
        .quiz-btn-container { display: flex; justify-content: center; gap: 15px; width: 100%; }
        .quiz-btn-container .ui-btn { flex: 1; padding: 12px 0; font-size: 22px; margin: 0; }
        .btn-skip { background: #E0E0E0; color: #555; border-color: #999; box-shadow: 0 5px 0 #999; }
        .btn-skip:active { box-shadow: 0 0 0 #999; }

        /* === ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ === */
        #mobile-controls { display: none; position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        #joystick-zone { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; position: relative; top: 35px; left: 35px; }
        #action-btn { position: absolute; bottom: 180px; right: 30px; width: 80px; height: 80px; background: #FF9800; border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 35px; color: white; opacity: 0.8; }
        #touch-rotation-zone { position: absolute; top: 0; right: 0; width: 50%; height: 80%; pointer-events: auto; }
        
/* íŒì—… ë’·ë°°ê²½ (í™”ë©´ì„ ì–´ë‘¡ê²Œ ë®ìŒ) */
.modal-overlay {
    position: fixed; /* ë˜ëŠ” ê²Œì„ í™”ë©´ì´ relativeë¼ë©´ absolute */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ê²€ì • */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000; /* ì œì¼ ìœ„ì— í‘œì‹œ */
}

/* íŒì—…ì°½ ë³¸ì²´ */
.modal-content {
    background-color: white;
    padding: 20px 40px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 3px solid #4CAF50; /* ê²Œì„ í…Œë§ˆìƒ‰ì— ë§ì¶° ë³€ê²½ ê°€ëŠ¥ */
    min-width: 300px;
    animation: popIn 0.3s ease; /* ë¿…! í•˜ê³  ë‚˜íƒ€ë‚˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
}

/* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
.modal-content h2 {
    margin-top: 0;
    color: #333;
}
.modal-content p {
    font-size: 1.2em;
    margin: 20px 0;
}

/* í™•ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#modal-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
#modal-btn:hover {
    background-color: #45a049;
}

/* ìˆ¨ê¹€ ì²˜ë¦¬ë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
.hidden {
    display: none !important;
}

/* íŒì—… ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

        /* === ì¼ì‹œì •ì§€ ë©”ë‰´ === */
        #pause-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto;
        }
        #pause-box { background: #fff; border: 6px solid #2196F3; border-radius: 20px; padding: 40px; text-align: center; }

        /* === ë¹Œë” UI === */
        #builder-ui { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:300; pointer-events:auto; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

<div id="world-container"></div>

<div id="main-menu">
    <div id="title-logo">LEGO MATH<br>WORLD</div>
    <div style="color:white; font-size:18px; margin-bottom:20px;">Ultimate Version</div>
    <button class="ui-btn btn-primary" onclick="showCharSelect()">â–¶ ê²Œì„ ì‹œì‘</button>
    <button class="ui-btn btn-success" onclick="startLoading('builder')">ğŸ› ï¸ ë™ë¬¼ ë§Œë“¤ê¸°</button>
</div>

<div id="game-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 id="modal-title">ì•Œë¦¼</h2>
        <p id="modal-message">ë©”ì‹œì§€ ë‚´ìš©</p>
        <button id="modal-btn" onclick="closeModal()">í™•ì¸</button>
    </div>
</div>

<div id="char-select" class="hidden">
    <h2 style="color:white; text-shadow:2px 2px 0 #000;">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
    <div style="display:flex;">
        <div class="char-card" onclick="selectChar('boy')">
            <div class="char-icon">ğŸ‘¦</div><div class="char-name">ì†Œ ë…„</div>
        </div>
        <div class="char-card" onclick="selectChar('girl')">
            <div class="char-icon">ğŸ‘§</div><div class="char-name">ì†Œ ë…€</div>
        </div>
        <div class="char-card" onclick="selectChar('robot')">
            <div class="char-icon">ğŸ¤–</div><div class="char-name">ë¡œ ë´‡</div>
        </div>
    </div>
    <button class="ui-btn btn-danger" onclick="backToMain()">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="loading-screen" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#222; color:white; display:flex; justify-content:center; align-items:center; z-index:600;">
    <h2>ì›”ë“œ ìƒì„± ì¤‘...</h2>
</div>

<div id="game-ui" class="hidden">
    <div id="hud-top-bar">
        <div id="score-box">â­ ì ìˆ˜: <span id="score">0</span></div>
        <div id="collection-container">
            <div id="collection-title">íšë“í•œ ë™ë¬¼ ë„ê°</div>
            <div id="collection-slots"></div>
        </div>
    </div>

    <div id="crosshair"></div>
    <div id="minimap-container"><canvas id="minimap" width="150" height="150"></canvas></div>
    
    <div id="pause-menu" class="hidden">
        <div id="pause-box">
            <h2 style="margin:0 0 20px 0;">ì¼ì‹œ ì •ì§€</h2>
            <button class="ui-btn btn-primary" onclick="togglePause()">â–¶ ê³„ì† í•˜ê¸°</button><br>
            <button class="ui-btn btn-danger" onclick="exitGame()">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>

    <div id="quiz-overlay" class="hidden">
        <div id="quiz-box">
            <div id="quiz-type-badge">ë¬¸ì œ</div>
            <div id="quiz-level">Lv.1</div>
            <div id="quiz-question"></div>
            
            <input type="tel" id="answer-input" placeholder="?" autocomplete="off">
            
            <div class="quiz-btn-container">
                <button class="ui-btn btn-primary" onclick="checkAnswer()">í™•ì¸</button>
                <button class="ui-btn btn-skip" onclick="giveUpQuiz()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="touch-rotation-zone"></div>
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
        <div id="action-btn">ğŸ‘‹</div>
    </div>
</div>

<div id="builder-ui" class="hidden">
    <div id="builder-canvas-container" style="width:100%; height:100%;"></div>
    <button class="ui-btn btn-danger" style="position:absolute; top:20px; right:20px;" onclick="exitBuilder()">ë‹«ê¸°</button>
    <div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:white; padding:10px; border-radius:10px; display:flex; gap:5px;">
        <div class="color-btn" style="width:30px;height:30px;background:red;cursor:pointer;border:1px solid #000;" onclick="selectColor('red')"></div>
        <div class="color-btn" style="width:30px;height:30px;background:yellow;cursor:pointer;border:1px solid #000;" onclick="selectColor('yellow')"></div>
        <div class="color-btn" style="width:30px;height:30px;background:green;cursor:pointer;border:1px solid #000;" onclick="selectColor('green')"></div>
        <div class="color-btn" style="width:30px;height:30px;background:blue;cursor:pointer;border:1px solid #000;" onclick="selectColor('blue')"></div>
        <button class="ui-btn btn-success" style="padding:5px 10px; font-size:14px;" onclick="saveAndSpawn()">ì†Œí™˜</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
    // ==========================================
    let gameState = 'menu'; 
    let scene, camera, renderer, raycaster;
    let playerGroup, cameraPivot; 
    let playerParts = { leftArm: null, rightArm: null, leftLeg: null, rightLeg: null };
    
    // ë¬¼ë¦¬ ì—”ì§„ ë° ì›€ì§ì„ ê´€ë ¨ ë³€ìˆ˜
    let velocityY = 0;
    let isGrounded = true;
    const gravity = -40; 
    const jumpForce = 15; 
    let isSprinting = false; 
    let moveF=false, moveB=false, moveL=false, moveR=false;
    let joyX=0, joyY=0;

    let animals = [], clouds = [], structures = [];
    let score = 0;
    let targetAnimal = null;
    let customAnimalData = [];
    let selectedCharType = 'boy';
    let isControlsSetup = false; 
    let cameraDistance = 10; 
    let prevTime = performance.now();
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 1024;

    // ==========================================
    // 2. ìˆ˜í•™ ë¬¸ì œ ìƒì„± ë° ì•„ì´ì½˜ ë¡œì§
    // ==========================================
    function generateMathProblem(type, level) {
        let range = level === 1 ? 9 : (level === 2 ? 50 : 100);
        let min = level === 1 ? 1 : 10;
        let a = min + Math.floor(Math.random() * range);
        let b = min + Math.floor(Math.random() * range);
        let q = "", ans = 0;

        const wordTemplates = [
            (a, b) => ({ q: `ì‚¬ê³¼ ${a}ê°œ, ë°° ${b}ê°œ. ëª¨ë‘ ëª‡ ê°œ?`, a: a+b }),
            (a, b) => ({ q: `ë²„ìŠ¤ ${a}ëª…, ${b}ëª… ë” íƒ”ìŒ. ì´ ëª‡ ëª…?`, a: a+b }),
            (a, b) => ({ q: `ì‚¬íƒ• ${a*b}ê°œë¥¼ ${b}ëª…ì—ê²Œ ë‚˜ëˆ„ë©´?`, a: a }),
            (a, b) => ({ q: `ìì „ê±° ${a}ëŒ€ì˜ ë°”í€´ ìˆ˜ëŠ”?`, a: a*2 }),
            (a, b) => ({ q: `ê°•ì•„ì§€ ${a}ë§ˆë¦¬ì˜ ë‹¤ë¦¬ ìˆ˜ëŠ”?`, a: a*4 })
        ];

        switch(type) {
            case 'add': q = `${a} + ${b} = ?`; ans = a + b; break;
            case 'sub': if(a < b) [a, b] = [b, a]; q = `${a} - ${b} = ?`; ans = a - b; break;
            case 'mul': a = 2 + Math.floor(Math.random()*8); b = 2 + Math.floor(Math.random()*8); q = `${a} x ${b} = ?`; ans = a * b; break;
            case 'div': b = 2 + Math.floor(Math.random()*8); ans = 2 + Math.floor(Math.random()*8); a = b * ans; q = `${a} Ã· ${b} = ?`; break;
            case 'word': const t = wordTemplates[Math.floor(Math.random()*wordTemplates.length)]; if(level>1) a+=10; const wQ=t(a,b); q=wQ.q; ans=wQ.a; break;
        }
        return { q, a: ans };
    }

    function createIconTexture(symbol, color) {
        const cvs = document.createElement('canvas');
        cvs.width = 128; cvs.height = 128;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(64,64,60,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 8; ctx.stroke();
        ctx.fillStyle = 'white'; ctx.font = 'bold 80px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(symbol, 64, 70);
        return new THREE.CanvasTexture(cvs);
    }
    const icons = {
        add: createIconTexture('+', '#4CAF50'),
        sub: createIconTexture('-', '#2196F3'),
        mul: createIconTexture('Ã—', '#FF9800'),
        div: createIconTexture('Ã·', '#E91E63'),
        word: createIconTexture('?', '#9C27B0')
    };

    // ==========================================
    // 3. UI ë° ê²Œì„ íë¦„ ì œì–´
    // ==========================================
    function showCharSelect() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('char-select').classList.remove('hidden');
    }
    function backToMain() {
        document.getElementById('char-select').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
    }
    function selectChar(type) {
        selectedCharType = type;
        document.getElementById('char-select').classList.add('hidden');
        startLoading('game');
    }
    function startLoading(target) {
        const loadScreen = document.getElementById('loading-screen');
        loadScreen.classList.remove('hidden');
        if(target === 'game') {
            document.getElementById('main-menu').classList.add('hidden');
            setTimeout(() => {
                if(!scene) initGameScene(); else resetGame();
                gameState = 'playing';
                loadScreen.classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                if(!isMobile) document.body.requestPointerLock();
            }, 500);
        } else {
            document.getElementById('main-menu').classList.add('hidden');
            setTimeout(() => {
                if(!builderScene) initBuilderScene();
                gameState = 'building';
                loadScreen.classList.add('hidden');
                document.getElementById('builder-ui').classList.remove('hidden');
            }, 500);
        }
    }
    document.addEventListener('pointerlockchange', () => {
        if (gameState === 'playing' && document.pointerLockElement === null) togglePause();
    });
    function togglePause() {
        if(gameState === 'playing') {
            gameState = 'paused';
            document.getElementById('pause-menu').classList.remove('hidden');
            if(document.pointerLockElement) document.exitPointerLock();
            moveF=moveB=moveL=moveR=false;
            isSprinting = false;
        } else if(gameState === 'paused') {
            gameState = 'playing';
            document.getElementById('pause-menu').classList.add('hidden');
            if(!isMobile) document.body.requestPointerLock();
        }
    }
    function exitGame() {
        gameState = 'menu';
        document.exitPointerLock();
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('pause-menu').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        if(playerGroup) { scene.remove(playerGroup); playerGroup=null; }
        animals.forEach(a => scene.remove(a)); animals=[];
        clouds.forEach(c => scene.remove(c)); clouds=[];
        structures.forEach(s => scene.remove(s)); structures=[];
        score = 0; document.getElementById('score').innerText = '0';
        document.getElementById('collection-slots').innerHTML = ''; 
        scene.children.filter(c => c.isInstancedMesh).forEach(m => scene.remove(m));
    }
    function resetGame() { exitGame(); initGameScene(); }

    // ==========================================
    // 4. ê²Œì„ ì”¬(Scene) ì´ˆê¸°í™”
    // ==========================================
    function initGameScene() {
        if(isMobile) document.getElementById('mobile-controls').style.display = 'block';
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 30, 200);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        const container = document.getElementById('world-container');
        container.innerHTML = ''; container.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(50, 100, 50); dir.castShadow = true; 
        dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
        scene.add(dir);

        const floorGeo = new THREE.PlaneGeometry(2000, 2000);
        const floorMat = new THREE.MeshPhongMaterial({ color: 0x8BC34A });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
        scene.add(floor);

        createPlayer();
        raycaster = new THREE.Raycaster();
        initEnvironment(); 
        
        // ë™ë¬¼ 60ë§ˆë¦¬ ìƒì„±
        for(let i=0; i<60; i++) spawnAnimal(true);

        velocityY = 0; isGrounded = true; isSprinting = false;

        if(!isControlsSetup) { setupGameControls(); isControlsSetup = true; }
        animate();
    }

    const boxGeo = new THREE.BoxGeometry(1, 1, 1);
    function createVoxel(color, x, y, z, sx, sy, sz) {
        const mat = new THREE.MeshPhongMaterial({ color: color });
        const mesh = new THREE.Mesh(boxGeo, mat);
        mesh.position.set(x, y, z);
        mesh.scale.set(sx, sy, sz);
        mesh.castShadow = true; mesh.receiveShadow = true;
        return mesh;
    }

    // ==========================================
    // 5. í™˜ê²½(Environment) ìƒì„± - ìµœì í™” & ë””í…Œì¼
    // ==========================================
    function initEnvironment() {
        // [ë‚˜ë¬´ ìµœì í™”] InstancedMesh ì‚¬ìš©
        const treeCount = 100;
        const dummy = new THREE.Object3D();
        const trunkMat = new THREE.MeshPhongMaterial({ color: 0x795548 });
        const trunkMesh = new THREE.InstancedMesh(boxGeo, trunkMat, treeCount);
        const leafMat = new THREE.MeshPhongMaterial({ color: 0x2E7D32 });
        const leafMesh = new THREE.InstancedMesh(boxGeo, leafMat, treeCount);
        trunkMesh.castShadow = true; trunkMesh.receiveShadow = true;
        leafMesh.castShadow = true; leafMesh.receiveShadow = true;

        for (let i = 0; i < treeCount; i++) {
            const pos = getRandPos();
            dummy.position.set(pos.x, 2, pos.z);
            dummy.scale.set(1.5, 4, 1.5); dummy.updateMatrix(); trunkMesh.setMatrixAt(i, dummy.matrix);
            dummy.position.set(pos.x, 5, pos.z);
            dummy.scale.set(4, 3, 4); dummy.updateMatrix(); leafMesh.setMatrixAt(i, dummy.matrix);
        }
        scene.add(trunkMesh); scene.add(leafMesh);

        // [í˜¸ìˆ˜]
        const lakeGeo = new THREE.CircleGeometry(20, 32);
        const lakeMat = new THREE.MeshPhongMaterial({ color: 0x2196F3 });
        for(let i=0; i<3; i++) {
            const lake = new THREE.Mesh(lakeGeo, lakeMat);
            lake.rotation.x = -Math.PI/2;
            lake.position.set((Math.random()-0.5)*300, 0.05, (Math.random()-0.5)*300);
            scene.add(lake); structures.push(lake);
        }
        
        // [ì‚°] ë³µì…€ ìŠ¤íƒ€ì¼ë¡œ ìŒ“ê¸°
        for(let i=0; i<5; i++) {
            const mt = new THREE.Group();
            const px = (Math.random()-0.5)*400, pz = (Math.random()-0.5)*400;
            mt.add(createVoxel(0x757575, 0, 5, 0, 30, 10, 30));
            mt.add(createVoxel(0x616161, 0, 15, 0, 20, 10, 20));
            mt.add(createVoxel(0xFFFFFF, 0, 22, 0, 10, 4, 10)); // ì„¤ì‚° ê¼­ëŒ€ê¸°
            mt.position.set(px, 0, pz); scene.add(mt); structures.push(mt);
        }
        
        // [ì§‘] ë””í…Œì¼í•œ ì§‘
        for(let i=0; i<8; i++) {
            const h = new THREE.Group();
            const px = (Math.random()-0.5)*300, pz = (Math.random()-0.5)*300;
            h.add(createVoxel(0xFFCC80, 0, 3, 0, 6, 6, 6)); // ë²½
            h.add(createVoxel(0x3E2723, 0, 7, 0, 7, 2, 7)); // ì§€ë¶•
            h.add(createVoxel(0x5D4037, 0, 8.5, 0, 5, 1, 5)); // êµ´ëš
            h.add(createVoxel(0x8D6E63, 0, 2, 3.1, 1.5, 3, 0.2)); // ë¬¸
            h.position.set(px, 0, pz); scene.add(h); structures.push(h);
        }
        
        // [êµ¬ë¦„]
        for(let i=0; i<40; i++) {
             const g = new THREE.Group();
             const c = 0xFFFFFF;
             g.add(createVoxel(c, 0, 0, 0, 4, 2, 3));
             g.add(createVoxel(c, 1.5, 1, 0, 3, 2, 2.5));
             const p = getRandPos();
             g.position.set(p.x, 40 + Math.random()*20, p.z);
             scene.add(g); clouds.push({ mesh: g, speed: 0.2 + Math.random()*0.3 });
        }
    }

    // ==========================================
    // 6. í”Œë ˆì´ì–´ ë° ë™ë¬¼ ìƒì„±
    // ==========================================
    function createLimb(color, w, h, d, x, y, z) {
        const group = new THREE.Group();
        group.position.set(x, y, z);
        const mesh = createVoxel(color, 0, -h/2, 0, w, h, d);
        group.add(mesh);
        return group;
    }

    function createPlayer() {
        playerGroup = new THREE.Group();
        const c = selectedCharType === 'boy' ? 0x1976D2 : (selectedCharType === 'girl' ? 0xE91E63 : 0x616161);
        const skin = selectedCharType === 'robot' ? 0xBDBDBD : 0xFFCC80;
        const pants = 0x333333;
        
        playerGroup.add(createVoxel(c, 0, 1.8, 0, 1.0, 1.2, 0.6)); // ëª¸í†µ
        
        const head = new THREE.Group();
        head.position.y = 2.4;
        head.add(createVoxel(skin, 0, 0.4, 0, 0.8, 0.8, 0.8)); // ë¨¸ë¦¬
        head.add(createVoxel(0x000000, -0.15, 0.5, -0.41, 0.1, 0.1, 0.05)); // ëˆˆ
        head.add(createVoxel(0x000000, 0.15, 0.5, -0.41, 0.1, 0.1, 0.05));
        playerGroup.add(head);

        // íŒ”ë‹¤ë¦¬ ìƒì„± (ê´€ì ˆ)
        playerParts.leftLeg = createLimb(pants, 0.4, 1.2, 0.5, -0.25, 1.2, 0);
        playerParts.rightLeg = createLimb(pants, 0.4, 1.2, 0.5, 0.25, 1.2, 0);
        playerParts.leftArm = createLimb(c, 0.3, 1.0, 0.4, -0.65, 2.3, 0);
        playerParts.rightArm = createLimb(c, 0.3, 1.0, 0.4, 0.65, 2.3, 0);
        
        playerGroup.add(playerParts.leftLeg); playerGroup.add(playerParts.rightLeg);
        playerGroup.add(playerParts.leftArm); playerGroup.add(playerParts.rightArm);
        
        cameraPivot = new THREE.Object3D();
        cameraPivot.position.set(0, 3, 0); 
        playerGroup.add(cameraPivot);
        
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
        camera.position.set(0, 2, cameraDistance); 
        cameraPivot.add(camera);
        
        playerGroup.position.set(0, 0, 0);
        scene.add(playerGroup);
    }

    // ìºë¦­í„° ê±·ê¸°/ë‹¬ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
    function updatePlayerAnim(dt, time) {
        if(!playerParts.leftLeg) return;
        const isMoving = moveF || moveB || moveL || moveR || Math.abs(joyX)>0.1 || Math.abs(joyY)>0.1;
        const animSpeed = isSprinting ? 20 : 10; 
        if(isMoving) {
            const angle = Math.sin(time * animSpeed) * 0.8;
            playerParts.leftLeg.rotation.x = angle; playerParts.rightLeg.rotation.x = -angle;
            playerParts.leftArm.rotation.x = -angle; playerParts.rightArm.rotation.x = angle;
        } else {
            playerParts.leftLeg.rotation.x = 0; playerParts.rightLeg.rotation.x = 0;
            playerParts.leftArm.rotation.x = 0; playerParts.rightArm.rotation.x = 0;
        }
    }

    // ë ˆë²¨ë³„ ì™•ê´€ ì—…ë°ì´íŠ¸ (ë””í…Œì¼ í™•ì¸)
    function updateAnimalCrown(animal) {
        const oldCrown = animal.getObjectByName('crown');
        if(oldCrown) animal.remove(oldCrown);

        const level = animal.userData.level;
        const g = new THREE.Group();
        g.name = 'crown';
        
        if (level <= 2) {
            // êµ¬ë¦¬ ì™•ê´€
            const c = 0xCD7F32;
            g.add(createVoxel(c, 0, 0, 0, 1.2, 0.2, 1.2));
        } else if (level <= 4) {
            // ì€ ì™•ê´€
            const c = 0xC0C0C0;
            g.add(createVoxel(c, 0, 0, 0, 1.2, 0.2, 1.2));
            g.add(createVoxel(c, -0.4, 0.3, 0, 0.2, 0.4, 0.2));
            g.add(createVoxel(c, 0.4, 0.3, 0, 0.2, 0.4, 0.2));
        } else if (level <= 6) {
            // ê¸ˆ ì™•ê´€
            const c = 0xFFD700;
            g.add(createVoxel(c, 0, 0, 0, 1.4, 0.2, 1.4));
            g.add(createVoxel(c, -0.4, 0.4, 0, 0.3, 0.6, 0.3));
            g.add(createVoxel(c, 0, 0.4, 0, 0.3, 0.6, 0.3));
            g.add(createVoxel(c, 0.4, 0.4, 0, 0.3, 0.6, 0.3));
        } else {
            // ë‹¤ì´ì•„ ë§ˆìŠ¤í„° ì™•ê´€
            const c = 0x00BFFF; 
            g.add(createVoxel(c, 0, 0, 0, 1.5, 0.3, 1.5));
            g.add(createVoxel(c, 0, 0.8, 0, 0.4, 1.2, 0.4)); 
            g.add(createVoxel(0xFFFFFF, 0, 1.5, 0, 0.3, 0.3, 0.3)); 
            g.add(createVoxel(c, -0.6, 0.4, 0, 0.2, 0.6, 0.2));
            g.add(createVoxel(c, 0.6, 0.4, 0, 0.2, 0.6, 0.2));
        }

        g.position.y = 7;
        animal.add(g);
    }

    function spawnAnimal(isRandom, type='random') {
        const g = new THREE.Group();
        let problemType = 'add';
        let variant = '', animalIcon = 'ğŸ¾';

        if(type === 'custom') {
            customAnimalData.forEach(d => g.add(createVoxel(d.c, d.x, d.y, d.z, 5, 5, 5)));
            g.position.y = 2.5; problemType = 'word'; animalIcon = 'ğŸ› ï¸';
        } else {
            const types = ['bear', 'rabbit', 'fox', 'duck', 'elephant', 'pig', 'lion'];
            const iconsMap = {'bear':'ğŸ»', 'rabbit':'ğŸ°', 'fox':'ğŸ¦Š', 'duck':'ğŸ¦†', 'elephant':'ğŸ˜', 'pig':'ğŸ·', 'lion':'ğŸ¦'};
            variant = types[Math.floor(Math.random()*types.length)];
            animalIcon = iconsMap[variant];

            if(['bear','elephant'].includes(variant)) problemType = 'add';
            else if(['fox','pig'].includes(variant)) problemType = 'sub';
            else if(['rabbit','lion'].includes(variant)) problemType = 'mul';
            else problemType = 'word';

            const addLegs = (color, w, h, d, ox, oz) => {
                g.add(createVoxel(color, -ox, h/2, oz, w, h, d)); g.add(createVoxel(color, ox, h/2, oz, w, h, d));
                g.add(createVoxel(color, -ox, h/2, -oz, w, h, d)); g.add(createVoxel(color, ox, h/2, -oz, w, h, d));
            };
            const addFace = (hy, hz, hs) => {
                g.add(createVoxel(0x000000, -0.4, hy+0.2, hz-hs/2-0.05, 0.15, 0.15, 0.1));
                g.add(createVoxel(0x000000, 0.4, hy+0.2, hz-hs/2-0.05, 0.15, 0.15, 0.1));
            }
            let c = 0xFFFFFF;
            if(variant==='bear') c = 0x795548; else if(variant==='fox') c = 0xFF5722; else if(variant==='pig') c = 0xF48FB1; 
            else if(variant==='lion') c = 0xFFB74D; else if(variant==='elephant') c = 0x90A4AE; else if(variant==='duck') c = 0xFFEB3B;

            if(variant === 'duck') {
                 g.add(createVoxel(c, 0, 2, 0, 2, 2, 3)); g.add(createVoxel(c, 0, 3.5, -1.2, 1.5, 1.5, 1.5));
                 g.add(createVoxel(0xFF9800, 0, 3.3, -2.0, 0.8, 0.3, 0.8));
            } else {
                addLegs(c, 0.6, 1.5, 0.6, 1, 1.2); g.add(createVoxel(c, 0, 2.5, 0, 2.5, 2, 3.5));
                g.add(createVoxel(c, 0, 4, -1.8, 1.8, 1.8, 1.8)); addFace(4, -1.8, 1.8);
            }
        }
        
        const iconMat = new THREE.SpriteMaterial({ map: icons[problemType], transparent: true });
        const sprite = new THREE.Sprite(iconMat);
        sprite.position.set(0, 7, 0); sprite.scale.set(4, 4, 1);
        g.add(sprite);

        g.userData = { 
            type: 'animal', moveT: 0, isMov: false, rotT: 0, 
            pType: problemType, icon: animalIcon, 
            isCollected: false, level: 1, 
            cooldown: 0 
        };
        
        if(isRandom) {
            const p = getRandPos(); g.position.set(p.x, 0, p.z);
        } else {
            const dir = new THREE.Vector3(); playerGroup.getWorldDirection(dir);
            g.position.copy(playerGroup.position).add(dir.multiplyScalar(20)); g.position.y = 0;
        }
        scene.add(g); animals.push(g);
    }

    function getRandPos() {
        const r = 50 + Math.random()*250; const t = Math.random()*Math.PI*2;
        return {x: r*Math.sin(t), z: r*Math.cos(t)};
    }

    // ==========================================
    // 7. ì»¨íŠ¸ë¡¤ (í‚¤ë³´ë“œ, ë§ˆìš°ìŠ¤, í„°ì¹˜)
    // ==========================================
    function setupGameControls() {
        document.addEventListener('keydown', e => {
            if(gameState !== 'playing') return;
            if(e.code === 'Escape') togglePause();
            switch(e.code) {
                case 'KeyW': moveF=true; break; case 'KeyS': moveB=true; break;
                case 'KeyA': moveL=true; break; case 'KeyD': moveR=true; break;
            }
        });
        document.addEventListener('keyup', e => {
            switch(e.code) {
                case 'KeyW': moveF=false; break; case 'KeyS': moveB=false; break;
                case 'KeyA': moveL=false; break; case 'KeyD': moveR=false; break;
            }
        });

        document.addEventListener('mousedown', e => {
            if(gameState !== 'playing') return;
            // ì¢Œí´ë¦­: ì í”„
            if(e.button === 0) {
                if(isGrounded) velocityY = jumpForce;
            }
            // ìš°í´ë¦­: ë‹¬ë¦¬ê¸°
            if(e.button === 2) {
                isSprinting = true;
            }
        });

        document.addEventListener('mouseup', e => {
            if(e.button === 2) {
                isSprinting = false;
            }
        });

        document.addEventListener('contextmenu', e => e.preventDefault());

        document.addEventListener('wheel', e => {
            if(gameState === 'playing') {
                cameraDistance += e.deltaY * 0.01;
                cameraDistance = Math.max(5, Math.min(20, cameraDistance)); 
                if(camera) camera.position.z = cameraDistance;
            }
        });
        document.addEventListener('mousemove', e => {
            if(gameState==='playing' && document.pointerLockElement && playerGroup) {
                playerGroup.rotation.y -= e.movementX * 0.002;
                cameraPivot.rotation.x -= e.movementY * 0.002;
                cameraPivot.rotation.x = Math.max(-0.6, Math.min(0.6, cameraPivot.rotation.x));
            }
        });

        const joy = document.getElementById('joystick-zone');
        const knob = document.getElementById('joystick-knob');
        let jc = {x:0, y:0};
        joy.addEventListener('touchstart', e=>{ e.preventDefault(); const r=joy.getBoundingClientRect(); jc={x:r.left+r.width/2, y:r.top+r.height/2}; handleJoy(e.touches[0]); });
        joy.addEventListener('touchmove', e=>{ e.preventDefault(); handleJoy(e.touches[0]); });
        joy.addEventListener('touchend', ()=>{ joyX=0; joyY=0; knob.style.transform='translate(0,0)'; });
        function handleJoy(t) {
            const dx = t.clientX - jc.x, dy = t.clientY - jc.y;
            const d = Math.min(60, Math.hypot(dx,dy)), a = Math.atan2(dy,dx);
            joyX = (d/60)*Math.cos(a); joyY = (d/60)*Math.sin(a);
            knob.style.transform = `translate(${d*Math.cos(a)}px, ${d*Math.sin(a)}px)`;
        }
        document.getElementById('action-btn').addEventListener('touchstart', (e)=>{ e.preventDefault(); if(isGrounded) velocityY = jumpForce; });
        let lx=0;
        document.getElementById('touch-rotation-zone').addEventListener('touchstart', e=>lx=e.touches[0].clientX);
        document.getElementById('touch-rotation-zone').addEventListener('touchmove', e=>{
            if(gameState==='playing' && playerGroup) playerGroup.rotation.y -= (e.touches[0].clientX - lx)*0.005;
            lx = e.touches[0].clientX;
        });
    }

    // ==========================================
    // 8. í€´ì¦ˆ ë° ìƒí˜¸ì‘ìš© ë¡œì§ (ìë™ ì¶©ëŒ í¬í•¨)
    // ==========================================
    function openQuiz(animal) {
        gameState = 'quiz';
        targetAnimal = animal;
        document.exitPointerLock();
        moveF=moveB=moveL=moveR=false; joyX=joyY=0; isSprinting = false;
        
        const type = animal.userData.pType;
        const level = animal.userData.level;
        const qData = generateMathProblem(type, level);

        targetAnimal.userData.currentQ = qData;
        document.getElementById('quiz-overlay').classList.remove('hidden');
        document.getElementById('quiz-question').innerText = qData.q;
        const typeNames = {add:'ë§ì…ˆ', sub:'ëº„ì…ˆ', mul:'ê³±ì…ˆ', div:'ë‚˜ëˆ—ì…ˆ', word:'ì£¼ê´€ì‹'};
        document.getElementById('quiz-type-badge').innerText = typeNames[type] || 'ë¬¸ì œ';
        document.getElementById('quiz-level').innerText = `Lv.${level}`;
        document.getElementById('answer-input').value = "";
        setTimeout(() => document.getElementById('answer-input').focus(), 100);
    }
    
    function checkAnswer() {
        const val = parseInt(document.getElementById('answer-input').value);
        if(val === targetAnimal.userData.currentQ.a) {
            score += 10 * targetAnimal.userData.level;
            document.getElementById('score').innerText = score;
            targetAnimal.userData.level++; 
            collectAnimal(targetAnimal); 
            showModal("ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰", `ì˜í–ˆì–´ìš”! +${10 * targetAnimal.userData.level}ì `);
            closeQuiz();
        } else {
            showModal("ì•„ì‰¬ì›Œìš”! ğŸ˜¢", "í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!");
            document.getElementById('answer-input').focus();
        }
    }

    function collectAnimal(animal) {
        animal.userData.isCollected = true;
        const sprite = animal.children.find(c => c.type === 'Sprite');
        if(sprite) sprite.visible = false;
        
        updateAnimalCrown(animal); // ì™•ê´€ ì—…ê·¸ë ˆì´ë“œ
        
        const slots = document.getElementById('collection-slots');
        const slot = document.createElement('div');
        slot.className = 'collected-item';
        slot.innerText = animal.userData.icon;
        slots.appendChild(slot);
    }

    function giveUpQuiz() { closeQuiz(); }
    


    function showModal(title, message) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        document.getElementById('game-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('game-modal').classList.add('hidden');
    }

    function closeQuiz() {
        // í€´ì¦ˆ ì¢…ë£Œ í›„ 3ì´ˆê°„ í•´ë‹¹ ë™ë¬¼ê³¼ ì¬ìƒí˜¸ì‘ìš© ë°©ì§€
        if(targetAnimal) {
            targetAnimal.userData.cooldown = Date.now() + 3000; 
        }
        document.getElementById('quiz-overlay').classList.add('hidden');
        gameState = 'playing';
        if(!isMobile) document.body.requestPointerLock();
    }

    function drawMinimap() {
        const c = document.getElementById('minimap');
        if(!c) return; 
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,150,150);
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(75,75,4,0,Math.PI*2); ctx.fill();
        animals.forEach(a => {
            const dx = (a.position.x - playerGroup.position.x) * 0.3;
            const dy = (a.position.z - playerGroup.position.z) * 0.3;
            const mapX = 75 + dx; const mapY = 75 + dy;
            if(mapX > 0 && mapX < 150 && mapY > 0 && mapY < 150) {
                ctx.fillStyle = a.userData.isCollected ? '#00FF00' : 'yellow'; 
                ctx.beginPath(); ctx.arc(mapX, mapY, 3, 0, Math.PI*2); ctx.fill();
            }
        });
        ctx.fillStyle = '#ccc';
        structures.forEach(s => {
            const dx = (s.position.x - playerGroup.position.x) * 0.3;
            const dy = (s.position.z - playerGroup.position.z) * 0.3;
            ctx.fillRect(75+dx-2, 75+dy-2, 4, 4);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        if(gameState === 'playing' || gameState === 'quiz' || gameState === 'paused') {
            const time = performance.now() / 1000;
            const dt = time - (prevTime/1000);
            prevTime = time * 1000;

            if(gameState === 'playing' && playerGroup) {
                // ë¬¼ë¦¬ ë° ì´ë™ ë¡œì§
                velocityY += gravity * dt;
                playerGroup.position.y += velocityY * dt;

                if(playerGroup.position.y < 0) {
                    playerGroup.position.y = 0;
                    velocityY = 0;
                    isGrounded = true;
                } else {
                    isGrounded = false;
                }

                const baseSpeed = 15;
                const runMultiplier = 2.5;
                const currentSpeed = (isSprinting ? baseSpeed * runMultiplier : baseSpeed) * dt;

                let dz = 0, dx = 0;
                if(moveF) dz = -1; if(moveB) dz = 1;
                if(moveL) dx = -1; if(moveR) dx = 1;
                dx += joyX; dz += joyY;
                if(dx || dz) {
                    playerGroup.translateX(dx * currentSpeed);
                    playerGroup.translateZ(dz * currentSpeed);
                }
                updatePlayerAnim(dt, time);
                drawMinimap();
            }
            clouds.forEach(c => {
                c.mesh.position.x += c.speed * dt * 10;
                if(c.mesh.position.x > 500) c.mesh.position.x = -500;
            });
            if(gameState !== 'paused') {
                const now = Date.now();
                animals.forEach((a, index) => {
                    // [ìë™ ì¶©ëŒ ê°ì§€ ë¡œì§]
                    if(gameState === 'playing' && !a.userData.isCollected) {
                        const distSq = playerGroup.position.distanceToSquared(a.position);
                        if(distSq < 25) { // ì•½ 5m ê±°ë¦¬ ì´ë‚´
                            if(now > a.userData.cooldown) {
                                openQuiz(a);
                                return;
                            }
                        }
                    }

                    if(a===targetAnimal && gameState==='quiz') return;
                    a.userData.moveT -= dt;
                    if(a.userData.moveT<=0) {
                        a.userData.isMov = Math.random()<0.5;
                        a.userData.moveT = 2+Math.random()*3;
                        if(a.userData.isMov) a.userData.rotT = Math.random()*Math.PI*2;
                    }
                    if(a.userData.isMov) {
                        a.rotation.y += (a.userData.rotT - a.rotation.y)*0.05;
                        a.translateZ(5*dt);
                        if(a.userData.type!=='custom') a.position.y = Math.abs(Math.sin(time*5)) * 0.5; 
                    }
                });
            }
            renderer.render(scene, camera);
        }
    }

    // ==========================================
    // 9. ë¹Œë” ëª¨ë“œ (Builder Mode) - ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
    // ==========================================
    let builderScene, builderCamera, builderRenderer, builderControls, tempBlock;
    let buildBlocks=[], selectedColor='red';
    function initBuilderScene() {
        const c = document.getElementById('builder-canvas-container');
        builderScene = new THREE.Scene(); builderScene.background = new THREE.Color(0x333);
        builderCamera = new THREE.PerspectiveCamera(50, c.clientWidth/c.clientHeight, 0.1, 1000);
        builderCamera.position.set(15,15,20);
        builderRenderer = new THREE.WebGLRenderer(); builderRenderer.setSize(c.clientWidth, c.clientHeight);
        c.innerHTML=''; c.appendChild(builderRenderer.domElement);
        builderScene.add(new THREE.DirectionalLight(0xffffff,1)); builderScene.add(new THREE.AmbientLight(0xffffff,0.6));
        builderScene.add(new THREE.GridHelper(30,30));
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(30,30), new THREE.MeshBasicMaterial({visible:false}));
        plane.rotation.x = -Math.PI/2; builderScene.add(plane);
        builderControls = new THREE.OrbitControls(builderCamera, builderRenderer.domElement);
        tempBlock = new THREE.Mesh(new THREE.BoxGeometry(5,5,5), new THREE.MeshBasicMaterial({color:0x00ff00, wireframe:true}));
        builderScene.add(tempBlock);
        const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
        c.addEventListener('mousemove', e=>{
            const r = c.getBoundingClientRect();
            mouse.x=((e.clientX-r.left)/r.width)*2-1; mouse.y=-((e.clientY-r.top)/r.height)*2+1;
            ray.setFromCamera(mouse, builderCamera);
            const ints = ray.intersectObjects([...buildBlocks, plane]);
            if(ints.length>0) {
                const p = ints[0].point.clone().add(ints[0].face.normal.multiplyScalar(2.5));
                p.divideScalar(5).floor().multiplyScalar(5).addScalar(2.5);
                tempBlock.position.copy(p); tempBlock.visible=true;
            } else tempBlock.visible=false;
        });
        c.addEventListener('pointerdown', e=>{
            if(!tempBlock.visible) return;
            const mat = new THREE.MeshPhongMaterial({color: selectedColor});
            const m = new THREE.Mesh(new THREE.BoxGeometry(5,5,5), mat);
            m.position.copy(tempBlock.position);
            builderScene.add(m); buildBlocks.push(m);
        });
        animateBuilder();
    }
    function animateBuilder() {
        if(gameState==='building') { requestAnimationFrame(animateBuilder); builderRenderer.render(builderScene, builderCamera); }
    }
    function exitBuilder() { gameState='menu'; document.getElementById('builder-ui').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }
    function selectColor(c) { selectedColor=c; }
    function saveAndSpawn() {
        if(buildBlocks.length===0) return alert("ë¸”ë¡ì„ ë†“ìœ¼ì„¸ìš”!");
        customAnimalData = buildBlocks.map(b=>({x:b.position.x, y:b.position.y, z:b.position.z, c:b.material.color.getHex()}));
        startLoading('game');
        setTimeout(()=>spawnAnimal(false, 'custom'), 1500);
    }
    window.addEventListener('resize', () => {
        if(camera) { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); }
        if(renderer) renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>